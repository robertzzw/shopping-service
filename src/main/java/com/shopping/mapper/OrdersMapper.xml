<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shopping.mapper.OrdersMapper">

    <resultMap id="BaseResultMap" type="com.shopping.entity.Order">
        <id column="order_id" property="orderId"/>
        <result column="order_no" property="orderNo"/>
        <result column="user_id" property="userId"/>
        <result column="merchant_id" property="merchantId"/>
        <result column="total_amount" property="totalAmount"/>
        <result column="order_status" property="orderStatus"/>
        <result column="payment_time" property="paymentTime"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
    </resultMap>
    <update id="updateOrderPaid">
        update orders set order_status = 1, payment_time = now()
        where order_id = #{orderId} and order_status = 0
    </update>

    <!-- 统计商家指定日期的销售额 -->
    <select id="sumMerchantSalesByDate" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0)
        FROM orders
        WHERE merchant_id = #{merchantId}
          AND order_status IN (1, 3, 5)
          AND DATE(created_time) = #{date}
    </select>

    <!-- 统计商家指定日期的已支付订单金额 -->
    <select id="sumMerchantPaidSalesByDate" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0)
        FROM orders
        WHERE merchant_id = #{merchantId}
          AND order_status = 1
          AND DATE(payment_time) = #{date}
    </select>

    <!-- 统计商家指定日期的已退款订单金额 -->
    <select id="sumMerchantRefundSalesByDate" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(total_amount), 0)
        FROM orders
        WHERE merchant_id = #{merchantId}
          AND order_status = 5
          AND DATE(updated_time) = #{date}
    </select>

    <!-- 查询商家指定日期的订单 -->
    <select id="findMerchantOrdersByDate" resultMap="BaseResultMap">
        SELECT *
        FROM orders
        WHERE merchant_id = #{merchantId}
          AND order_status IN (1, 5)
          AND DATE(created_time) = #{date}
        ORDER BY created_time DESC
    </select>

</mapper>